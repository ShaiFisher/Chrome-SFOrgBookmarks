var sfobApp=angular.module("sfobApp",[]);sfobApp.controller("popupCtrl",["$scope","bookmarksService","windowService","utils","OrgBookmarks","$timeout",function(a,b,c,d,e,f){function g(a,b,c){if(a.lastUseDate){var e=Math.min(d.daysUntillNow(a.lastUseDate),b||i);a.dayswithoutUse=e,a.opacity=1-e/(c||j)}else a.opacity=1-h}const h=.6,i=60,j=i/h,k=360;a.displaySettings=!0;var l=function(c){b.getBookmarks(c).then(function(b){a.orgBookmarks=b,b.orgId&&!b.name&&(a.editOrg=!0),angular.forEach(b.getAllBookmarks(),function(a){g(a)})})};c.getOrgId().then(function(b){a.currentOrgId=b,l(b)}),b.getLastExportDate().then(function(c){c?(a.daysFromLastExport=d.daysUntillNow(c),a.displayLastExportWarning=a.daysFromLastExport>20):(b.setLastExportDateAsNow(),a.daysFromLastExport="(never)")}),a.saveChanges=function(){b.updateBookmarks(a.orgBookmarks)},a.deleteAllBookmarks=function(){confirm("Are you sure you want to delete all bookmarks for \""+a.orgBookmarks.name+"\"?")&&(a.orgBookmarks.groups=[],a.saveChanges())},a.addBookmark=function(b){c.getActiveTab().then(function(c){let d=c.title.indexOf(" ~ ");0>d&&(d=c.title.indexOf(" | "));const e=0<d?c.title.substring(0,d):c.title;a.orgBookmarks.addBookmark(e,c.url,b),a.saveChanges()})},a.deleteBookmark=function(b,c){a.orgBookmarks.deleteBookmark(b,c),a.saveChanges()},a.moveBookmark=function(b,c,d){var e=a.orgBookmarks.moveBookmark(b,c,d);e&&a.saveChanges()},a.shiftGroup=function(b,c){var d=a.orgBookmarks.shiftGroup(b,c);d&&a.saveChanges()},a.openBookmark=function(b,c){c?(b.openInNewTab(),a.saveChanges()):b.open(),f(function(){g(b),a.saveChanges()},500)},a.copyText=function(a){navigator&&navigator.clipboard&&navigator.clipboard.writeText(a)};a.addGroup=function(){var b=a.orgBookmarks.addGroup();b.editMode=!0,a.saveChanges()},a.deleteGroup=function(b){a.orgBookmarks.deleteGroup(b),a.saveChanges()},a.showOrgsList=function(){b.getAllOrgsBookmarks().then(function(c){a.orgsList=Object.values(c).map(a=>({orgId:a.orgId,name:a.name,lastUseDate:b.getLastUseDate(a),groups:a.groups})),a.orgsList.forEach(a=>{g(a,k,k/h),a.lastUseDateStr=a.lastUseDate?a.lastUseDate.toLocaleDateString():"?"}),a.displayOrgsList=!0})},a.selectOrg=function(b){a.currentOrgId=b.orgId,l(b.orgId),a.displayOrgsList=!1},a.deleteOrg=function(c){confirm("Are you sure you want do delete "+c.name+"?")&&(b.removeOrg(c.orgId),a.orgsList=a.orgsList.filter(a=>a.orgId!==c.orgId))},a.sortOrgsByName=function(){a.orgsList.sort((c,a)=>(c.name||"").localeCompare(a.name))},a.sortOrgsByDate=function(){a.orgsList.sort((c,a)=>(a.lastUseDate?.toISOString()||"").localeCompare(c.lastUseDate?.toISOString()||""))},a.toggleDisplaySettings=function(){a.displaySettings=!0,a.displayOrgsList=!1},a.exportBookmarks=function(){b.getAllOrgsBookmarks().then(function(c){a.bookmarksJson=angular.toJson(c),b.setLastExportDateAsNow(),a.daysFromLastExport=0,a.displayLastExportWarning=!1})},a.importBookmarks=function(){try{var c=angular.fromJson(a.bookmarksJson)}catch(b){a.settingsMessage="Invalid JSON string"}c&&b.importOrgsBookmarks(c,a.replaceCurrentData).then(function(b){a.settingsMessage="Imported "+b.numOrgs+" orgs ("+b.numNewOrgs+" new).",a.currentOrgId&&l(a.currentOrgId)})},a.changeSFInstance=function(){a.oldSFInstance&&a.newSFInstance&&(a.orgBookmarks.changeSFInstance(a.oldSFInstance,a.newSFInstance),a.saveChanges(),alert("Instance has been changed for all bookmarks in this org"))},a.$watch("displaySettings",function(){a.settingsMessage=""})}]);sfobApp.directive("bookmarkEditForm",["$interval","$timeout",function(){return{restrict:"EA",scope:{orgBookmarks:"=",group:"=",bookmark:"=",onClose:"&"},template:"<div class=\"bookmark-edit-form-wrap\"><input type=\"text\" ng-model=\"bookmark.title\"/><input type=\"text\" ng-model=\"bookmark.url\"/><div><select ng-model=\"selectedGroup\" ng-options=\"group.name for group in groups\" ng-change=\"moveToGroup(selectedGroup)\"></select></div></div>",link:function(a){a.selectedGroup=a.group,a.groups=a.orgBookmarks.groups,a.moveToGroup=function(b){a.orgBookmarks.moveBookmarkToGroup(a.bookmark,a.group,b),a.group=b,a.onClose&&a.onClose()}}}}]);sfobApp.factory("OrgBookmarks",["$q","utils","Bookmark",function(a,b,c){const d="Default";var e={addGroup:function(a){var b={name:a||"New Group",createdDate:new Date,bookmarks:[]};return this.groups.push(b),b},deleteGroup:function(a){delete this.groups[a]},getDefaultGroup:function(){this.groups=this.groups||[];var a=this.groups;if(0==a.length)return this.addGroup(d),a[0];var b=a[0];return angular.forEach(a,function(a){a.name==d&&(b=a)}),b},shiftGroup:function(a,c){var d=this.groups.indexOf(a),e=b.switchItems(this.groups,d,d+c);return e},isInGroup:function(a,b){for(var c=0;c<a.bookmarks.length;c++)if(a.bookmarks[c].url==b)return!0;return!1},getIndex:function(a,b){return a.bookmarks.indexOf(b)},addBookmark:function(a,b,d){var e=new c(null,a,b);d=d||this.getDefaultGroup(),this.isInGroup(d,b)||d.bookmarks.push(e)},deleteBookmark:function(a,b){var c=this.getIndex(a,b);a.bookmarks.splice(c,1)},moveBookmark:function(a,c,d){var e=this.getIndex(a,c),f=b.switchItems(a.bookmarks,e,e+d);return f},moveBookmarkToGroup:function(a,b,c){c.bookmarks.push(a),this.deleteBookmark(b,a)},getAllBookmarks:function(){var a=[];return angular.forEach(this.groups,function(b){angular.forEach(b.bookmarks,function(b){a.push(b)})}),a},mergeBookmarks:function(a){var c=this,d=b.arrayToMap(this.groups,"name");angular.forEach(a.groups,function(a){var b=a.name,e=d[b];e?angular.forEach(a.bookmarks,function(a){c.addBookmark(a.title,a.url,e)}):(c.groups.push(a),d[b]=a)})},forEachGroup:function(a){angular.forEach(this.groups,function(b){a(b)})},forEachBookmark:function(a){this.forEachGroup(function(b){angular.forEach(b.bookmarks,function(b){a(b)})})},changeSFInstance:function(a,b){this.forEachBookmark(function(c){console.log("bookmark:",c.title),c.changeSFInstance(a,b)})}};return function(a,d){return a=a||{orgId:d},angular.merge(a,e),a.orgId=a.orgId||d,a.groups=b.removeEmptyItems(a.groups),angular.forEach(a.groups,function(a){a.createdDate||(a.createdDate=new Date);for(var b=0;b<a.bookmarks.length;b++)a.bookmarks[b]=new c(a.bookmarks[b])}),a.bookmarks&&(angular.forEach(a.bookmarks,function(b){a.addBookmark(b.title,b.url)}),delete a.bookmarks),a}}]);sfobApp.factory("storageService",["$q","utils",function(a){return{load:function(b){var c=a.defer();return chrome.storage.sync.get(b,function(a){c.resolve(a[b])}),c.promise},loadMultiple:function(b){var c=a.defer();return chrome.storage.sync.get(b,function(a){c.resolve(a)}),c.promise},save:function(b,c){var d=a.defer(),e={};return e[b]=c,chrome.storage.sync.set(e,function(){d.resolve()}),d.promise},remove:function(a){chrome.storage.sync.remove([a])},saveMultiple:function(b){var c=a.defer();return chrome.storage.sync.set(b,function(){c.resolve()}),c.promise},removeMultiple:function(a){chrome.storage.sync.remove(a)}}}]);sfobApp.factory("utils",["$q",function(){var a=[];return{log:function(b,c,d,e){console.log(b,c,d,e),logMsg=b+(c?" "+c:"")+(d?" "+d:"")+(e?" "+e:""),angular.forEach(a,function(a){a(logMsg)})},addLogHandler:function(b){a.push(b)},switchItems:function(a,b,c){if(0<=b&&b<a.length&&0<=c&&c<a.length){var d=a[b],e=a[c];return a[c]=null,a[b]=e,a[c]=d,!0}return!1},removeEmptyItems:function(a){var b=[];return angular.forEach(a,function(a){a&&b.push(a)}),b},daysBetween:function(a,b){return Math.round(Math.abs((a.getTime()-b.getTime())/86400000))},daysUntillNow:function(a){var b=new Date;return this.daysBetween(a,b)},arrayToMap:function(a,b){var c={};return angular.forEach(a,function(a){var d=a[b];c[d]=a}),c}}}]);sfobApp.factory("windowService",["$q","utils","storageService",function(a,b,c){const d="lastOrgId";return{getActiveTab:function(){var b=a.defer();return chrome.tabs.query({active:!0,currentWindow:!0},function(a){b.resolve(a[0])}),b.promise},getActiveTabId:function(){var b=a.defer();return this.getActiveTab().then(function(a){b.resolve(a.id)}),b.promise},navigateTo:function(a){this.getActiveTab().then(function(b){chrome.tabs.update(b.id,{url:a})})},openInNewTab:function(a){chrome.tabs.create({url:a})},getOrgId:function(){var b=a.defer();return this.getActiveTabId().then(function(a){chrome.tabs.sendMessage(a,"getOrgId",function(a){"undefined"==a&&(a=""),a?(c.save(d,a),b.resolve(a)):c.load(d).then(function(a){b.resolve(a)})})}),b.promise}}}]);sfobApp.factory("Bookmark",["$q","utils","windowService",function(a,b,c){var d={title:"",url:"",createdDate:"",lastUseDate:""};return function(a,b,e){return d=a||{title:b,url:e},d.createdDate=d.createdDate?new Date(d.createdDate):new Date,d.lastUseDate=d.lastUseDate?new Date(d.lastUseDate):new Date,d.open=function(){a.lastUseDate=new Date,c.navigateTo(this.url)},d.openInNewTab=function(){a.lastUseDate=new Date,c.openInNewTab(this.url)},d.changeSFInstance=function(a,b){this.url=this.url.replace(a,b)},d}}]);sfobApp.factory("bookmarksService",["$q","utils","OrgBookmarks","storageService",function(a,b,c,d){function e(a){return"orgInfo_"+a}const f="orglist",g="lastExport";return{getBookmarks:function(b){this.addToOrgsList(b);var f=a.defer(),g=e(b);return d.load(g).then(function(a){angular.isObject(a)||(a=angular.fromJson(a));var d=new c(a,b);f.resolve(d)}),f.promise},updateBookmarks:function(a){var b=angular.toJson(a),c=e(a.orgId);d.save(c,b)},addToOrgsList:function(a){this.getAllOrgsIds().then(function(b){b=b||[],-1==b.indexOf(a)&&(b.push(a),d.save(f,b))})},getAllOrgsIds:function(){var b=a.defer();return d.load(f).then(function(a){b.resolve(a)}),b.promise},getAllOrgsKeys:function(){var b=a.defer();return this.getAllOrgsIds().then(function(a){var c=a.map(a=>e(a));b.resolve(c)}),b.promise},getAllOrgsBookmarks:function(){var b=a.defer();return this.getAllOrgsKeys().then(function(a){d.loadMultiple(a).then(function(a){var c={};angular.forEach(a,function(a){angular.isObject(a)||(a=angular.fromJson(a)),a.orgId&&(c[a.orgId]=a)}),b.resolve(c)})}),b.promise},getLastUseDate:function(a){let b;return a.groups.forEach(a=>{a&&a.bookmarks&&a.bookmarks.forEach(a=>{if(a.lastUseDate&&(!b||a.lastExportDate>b)){const c=new Date(a.lastUseDate);c instanceof Date&&!isNaN(c)&&(b=c)}})}),b},removeOrg:function(a){const b=e(a);d.remove(b),this.getAllOrgsIds().then(function(b){b=b.filter(b=>b!==a),d.save(f,b)})},removeAllOrgs:function(){return this.getAllOrgsKeys().then(function(a){d.removeMultiple(a),d.save(f,[])})},importOrgsBookmarks:function(b,g){var h=a.defer(),i=this,j=function(g,i){var j=0,k=0,l={};angular.forEach(b,function(a){j++;var b=i[a.orgId];if(!b)k++,g.push(a.orgId);else{var b=i[a.orgId],d=new c(b);d.mergeBookmarks(a),a=d}var f=e(a.orgId);l[f]=a}),a.all([d.saveMultiple(l),d.save(f,g)]).then(function(){h.resolve({numOrgs:j,numNewOrgs:k})})};return g?i.removeAllOrgs().then(function(){j([],{})}):i.getAllOrgsIds().then(function(a){i.getAllOrgsBookmarks().then(function(b){j(a,b)})}),h.promise},getLastExportDate:function(){var b=a.defer();return d.load(g).then(function(a){a?b.resolve(new Date(a)):b.resolve(null)}),b.promise},setLastExportDateAsNow:function(){var a=new Date;d.save(g,a.toString())}}}]);