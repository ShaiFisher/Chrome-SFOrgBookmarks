var sfobApp=angular.module("sfobApp",[]);sfobApp.controller("popupCtrl",["$scope","bookmarksService","windowService","utils","OrgBookmarks","$timeout",function(o,e,r,t,n,a){function s(o){var e=Math.min(t.daysUntillNow(o.lastUseDate),u);o.opacity=1-e/i}const u=60,i=100,c=20;o.displaySettings=!0;var g=function(r){e.getBookmarks(r).then(function(e){o.orgBookmarks=e,e.orgId&&!e.name&&(o.editOrg=!0),angular.forEach(e.getAllBookmarks(),function(o){s(o)})})};r.getOrgId().then(function(e){o.currentOrgId=e,g(e)}),e.getLastExportDate().then(function(r){r?(o.daysFromLastExport=t.daysUntillNow(r),o.displayLastExportWarning=o.daysFromLastExport>c):(e.setLastExportDateAsNow(),o.daysFromLastExport="(never)")}),o.saveChanges=function(){e.updateBookmarks(o.orgBookmarks)},o.deleteAllBookmarks=function(){o.orgBookmarks.groups=[],o.saveChanges()},o.addBookmark=function(e){r.getActiveTab().then(function(r){var t=r.title.indexOf(" ~ "),n=t>0?r.title.substring(0,t):r.title;t=n.indexOf(" | "),t>-1&&(n=n.substring(t+3)),o.orgBookmarks.addBookmark(n,r.url,e),o.saveChanges()})},o.deleteBookmark=function(e,r){o.orgBookmarks.deleteBookmark(e,r),o.saveChanges()},o.moveBookmark=function(e,r,t){var n=o.orgBookmarks.moveBookmark(e,r,t);n&&o.saveChanges()},o.shiftGroup=function(e,r){var t=o.orgBookmarks.shiftGroup(e,r);t&&o.saveChanges()},o.openBookmark=function(e,r){r?(e.openInNewTab(),o.saveChanges()):e.open(),a(function(){s(e),o.saveChanges()},500)},o.addGroup=function(){var e=o.orgBookmarks.addGroup();e.editMode=!0,o.saveChanges()},o.deleteGroup=function(e){o.orgBookmarks.deleteGroup(e),o.saveChanges()},o.exportBookmarks=function(){e.getAllOrgsBookmarks().then(function(r){o.bookmarksJson=angular.toJson(r),e.setLastExportDateAsNow(),o.daysFromLastExport=0,o.displayLastExportWarning=!1})},o.importBookmarks=function(){try{var r=angular.fromJson(o.bookmarksJson)}catch(t){o.settingsMessage="Invalid JSON string"}r&&e.importOrgsBookmarks(r,o.replaceCurrentData).then(function(e){o.settingsMessage="Imported "+e.numOrgs+" orgs ("+e.numNewOrgs+" new).",o.currentOrgId&&g(o.currentOrgId)})},o.changeSFInstance=function(){o.oldSFInstance&&o.newSFInstance&&(o.orgBookmarks.changeSFInstance(o.oldSFInstance,o.newSFInstance),o.saveChanges(),alert("Instance has been changed for all bookmarks in this org"))},o.$watch("displaySettings",function(){o.settingsMessage=""})}]),sfobApp.factory("windowService",["$q","utils","storageService",function(o,e,r){const t="lastOrgId";return{getActiveTab:function(){var e=o.defer();return chrome.tabs.query({active:!0,currentWindow:!0},function(o){e.resolve(o[0])}),e.promise},getActiveTabId:function(){var e=o.defer();return this.getActiveTab().then(function(o){e.resolve(o.id)}),e.promise},navigateTo:function(o){this.getActiveTab().then(function(e){chrome.tabs.update(e.id,{url:o})})},openInNewTab:function(o){chrome.tabs.create({url:o})},getOrgId:function(){var e=o.defer();return this.getActiveTabId().then(function(o){chrome.tabs.sendMessage(o,"getOrgId",function(o){"undefined"==o&&(o=""),o?(r.save(t,o),e.resolve(o)):r.load(t).then(function(o){e.resolve(o)})})}),e.promise}}}]),sfobApp.factory("Bookmark",["$q","utils","windowService",function(o,e,r){var t={title:"",url:"",createdDate:"",lastUseDate:""};return function(o,e,n){return t=o||{title:e,url:n},t.createdDate=t.createdDate?new Date(t.createdDate):new Date,t.lastUseDate=t.lastUseDate?new Date(t.lastUseDate):new Date,t.open=function(){o.lastUseDate=new Date,r.navigateTo(this.url)},t.openInNewTab=function(){o.lastUseDate=new Date,r.openInNewTab(this.url)},t.changeSFInstance=function(o,e){this.url=this.url.replace(o,e)},t}}]),sfobApp.factory("OrgBookmarks",["$q","utils","Bookmark",function(o,e,r){const t="Default",n="New Group";var a={addGroup:function(o){var e={name:o||n,createdDate:new Date,bookmarks:[]};return this.groups.push(e),e},deleteGroup:function(o){delete this.groups[o]},getDefaultGroup:function(){this.groups=this.groups||[];var o=this.groups;if(0==o.length)return this.addGroup(t),o[0];var e=o[0];return angular.forEach(o,function(o){o.name==t&&(e=o)}),e},shiftGroup:function(o,r){var t=this.groups.indexOf(o),n=e.switchItems(this.groups,t,t+r);return n},isInGroup:function(o,e){for(var r=0;r<o.bookmarks.length;r++)if(o.bookmarks[r].url==e)return!0;return!1},getIndex:function(o,e){return o.bookmarks.indexOf(e)},addBookmark:function(o,e,t){var n=new r(null,o,e);t=t||this.getDefaultGroup(),this.isInGroup(t,e)||t.bookmarks.push(n)},deleteBookmark:function(o,e){var r=this.getIndex(o,e);o.bookmarks.splice(r,1)},moveBookmark:function(o,r,t){var n=this.getIndex(o,r),a=e.switchItems(o.bookmarks,n,n+t);return a},moveBookmarkToGroup:function(o,e,r){r.bookmarks.push(o),this.deleteBookmark(e,o)},getAllBookmarks:function(){var o=[];return angular.forEach(this.groups,function(e){angular.forEach(e.bookmarks,function(e){o.push(e)})}),o},mergeBookmarks:function(o){var r=this,t=e.arrayToMap(this.groups,"name");angular.forEach(o.groups,function(o){var e=o.name,n=t[e];n?angular.forEach(o.bookmarks,function(o){r.addBookmark(o.title,o.url,n)}):(r.groups.push(o),t[e]=o)})},forEachGroup:function(o){angular.forEach(this.groups,function(e){o(e)})},forEachBookmark:function(o){this.forEachGroup(function(e){angular.forEach(e.bookmarks,function(e){o(e)})})},changeSFInstance:function(o,e){this.forEachBookmark(function(r){console.log("bookmark:",r.title),r.changeSFInstance(o,e)})}};return function(o,t){return o=o||{orgId:t},angular.merge(o,a),o.orgId=o.orgId||t,o.groups=e.removeEmptyItems(o.groups),angular.forEach(o.groups,function(o){o.createdDate||(o.createdDate=new Date);for(var e=0;e<o.bookmarks.length;e++)o.bookmarks[e]=new r(o.bookmarks[e])}),o.bookmarks&&(angular.forEach(o.bookmarks,function(e){o.addBookmark(e.title,e.url)}),delete o.bookmarks),o}}]),sfobApp.factory("bookmarksService",["$q","utils","OrgBookmarks","storageService",function(o,e,r,t){function n(o){return"orgInfo_"+o}const a="orglist",s="lastExport";return{getBookmarks:function(e){this.addToOrgsList(e);var a=o.defer(),s=n(e);return t.load(s).then(function(o){angular.isObject(o)||(o=angular.fromJson(o));var t=new r(o,e);a.resolve(t)}),a.promise},updateBookmarks:function(o){var e=angular.toJson(o),r=n(o.orgId);t.save(r,e)},addToOrgsList:function(o){this.getAllOrgsIds().then(function(e){e=e||[],-1==e.indexOf(o)&&(e.push(o),t.save(a,e))})},getAllOrgsIds:function(){var e=o.defer();return t.load(a).then(function(o){e.resolve(o)}),e.promise},getAllOrgsKeys:function(){var e=o.defer();return this.getAllOrgsIds().then(function(o){var r=[];angular.forEach(o,function(o){r.push(n(o))}),e.resolve(r)}),e.promise},getAllOrgsBookmarks:function(){var e=o.defer();return this.getAllOrgsKeys().then(function(o){t.loadMultiple(o).then(function(o){var r={};angular.forEach(o,function(o){angular.isObject(o)||(o=angular.fromJson(o)),o.orgId&&(r[o.orgId]=o)}),e.resolve(r)})}),e.promise},removeAllOrgs:function(){return this.getAllOrgsKeys().then(function(o){t.removeMultiple(o),t.save(a,[])})},importOrgsBookmarks:function(e,s){var u=o.defer(),i=this,c=function(s,i){var c=0,g=0,l={};angular.forEach(e,function(o){c++;var e=i[o.orgId];if(e){var e=i[o.orgId],t=new r(e);t.mergeBookmarks(o),o=t}else g++,s.push(o.orgId);var a=n(o.orgId);l[a]=o}),o.all([t.saveMultiple(l),t.save(a,s)]).then(function(){u.resolve({numOrgs:c,numNewOrgs:g})})};return s?i.removeAllOrgs().then(function(){c([],{})}):i.getAllOrgsIds().then(function(o){i.getAllOrgsBookmarks().then(function(e){c(o,e)})}),u.promise},getLastExportDate:function(){var e=o.defer();return t.load(s).then(function(o){o?e.resolve(new Date(o)):e.resolve(null)}),e.promise},setLastExportDateAsNow:function(){var o=new Date;t.save(s,o.toString())}}}]),sfobApp.factory("storageService",["$q","utils",function(o){return{load:function(e){var r=o.defer();return chrome.storage.sync.get(e,function(o){r.resolve(o[e])}),r.promise},loadMultiple:function(e){var r=o.defer();return chrome.storage.sync.get(e,function(o){r.resolve(o)}),r.promise},save:function(e,r){var t=o.defer(),n={};return n[e]=r,chrome.storage.sync.set(n,function(){t.resolve()}),t.promise},saveMultiple:function(e){var r=o.defer();return chrome.storage.sync.set(e,function(){r.resolve()}),r.promise},removeMultiple:function(o){chrome.storage.sync.remove(o)}}}]),sfobApp.factory("utils",["$q",function(){const o=864e5;var e=[];return{log:function(o,r,t,n){console.log(o,r,t,n),logMsg=o+(r?" "+r:"")+(t?" "+t:"")+(n?" "+n:""),angular.forEach(e,function(o){o(logMsg)})},addLogHandler:function(o){e.push(o)},switchItems:function(o,e,r){if(e>=0&&e<o.length&&r>=0&&r<o.length){var t=o[e],n=o[r];return o[r]=null,o[e]=n,o[r]=t,!0}return!1},removeEmptyItems:function(o){var e=[];return angular.forEach(o,function(o){o&&e.push(o)}),e},daysBetween:function(e,r){return Math.round(Math.abs((e.getTime()-r.getTime())/o))},daysUntillNow:function(o){var e=new Date;return this.daysBetween(o,e)},arrayToMap:function(o,e){var r={};return angular.forEach(o,function(o){var t=o[e];r[t]=o}),r}}}]),sfobApp.directive("bookmarkEditForm",["$interval","$timeout",function(){return{restrict:"EA",scope:{orgBookmarks:"=",group:"=",bookmark:"=",onClose:"&"},template:'<div class="bookmark-edit-form-wrap"><input type="text" ng-model="bookmark.title"/><input type="text" ng-model="bookmark.url"/><div><select ng-model="selectedGroup" ng-options="group.name for group in groups" ng-change="moveToGroup(selectedGroup)"></select></div></div>',link:function(o){o.selectedGroup=o.group,o.groups=o.orgBookmarks.groups,o.moveToGroup=function(e){o.orgBookmarks.moveBookmarkToGroup(o.bookmark,o.group,e),o.group=e,o.onClose&&o.onClose()}}}}]);