var sfobApp=angular.module("sfobApp",[]);sfobApp.controller("popupCtrl",["$scope","bookmarksService","windowService","utils","OrgBookmarks","$timeout",function(n,e,o,r,t,a){n.displaySettings=!0;function s(o){e.getBookmarks(o).then(function(o){(n.orgBookmarks=o).orgId&&!o.name&&(n.editOrg=!0),angular.forEach(o.getAllBookmarks(),function(o){u(o)})})}function u(o){var e=Math.min(r.daysUntillNow(o.lastUseDate),60);o.opacity=1-e/100}o.getOrgId().then(function(o){n.currentOrgId=o,s(o)}),e.getLastExportDate().then(function(o){o?(n.daysFromLastExport=r.daysUntillNow(o),n.displayLastExportWarning=20<n.daysFromLastExport):(e.setLastExportDateAsNow(),n.daysFromLastExport="(never)")}),n.saveChanges=function(){e.updateBookmarks(n.orgBookmarks)},n.deleteAllBookmarks=function(){n.orgBookmarks.groups=[],n.saveChanges()},n.addBookmark=function(t){o.getActiveTab().then(function(o){let e=o.title.indexOf(" ~ ");e<0&&(e=o.title.indexOf(" | "));var r=0<e?o.title.substring(0,e):o.title;n.orgBookmarks.addBookmark(r,o.url,t),n.saveChanges()})},n.deleteBookmark=function(o,e){n.orgBookmarks.deleteBookmark(o,e),n.saveChanges()},n.moveBookmark=function(o,e,r){n.orgBookmarks.moveBookmark(o,e,r)&&n.saveChanges()},n.shiftGroup=function(o,e){n.orgBookmarks.shiftGroup(o,e)&&n.saveChanges()},n.openBookmark=function(o,e){e?(o.openInNewTab(),n.saveChanges()):o.open(),a(function(){u(o),n.saveChanges()},500)},n.addGroup=function(){n.orgBookmarks.addGroup().editMode=!0,n.saveChanges()},n.deleteGroup=function(o){n.orgBookmarks.deleteGroup(o),n.saveChanges()},n.exportBookmarks=function(){e.getAllOrgsBookmarks().then(function(o){n.bookmarksJson=angular.toJson(o),e.setLastExportDateAsNow(),n.daysFromLastExport=0,n.displayLastExportWarning=!1})},n.importBookmarks=function(){try{var o=angular.fromJson(n.bookmarksJson)}catch(o){n.settingsMessage="Invalid JSON string"}o&&e.importOrgsBookmarks(o,n.replaceCurrentData).then(function(o){n.settingsMessage="Imported "+o.numOrgs+" orgs ("+o.numNewOrgs+" new).",n.currentOrgId&&s(n.currentOrgId)})},n.changeSFInstance=function(){n.oldSFInstance&&n.newSFInstance&&(n.orgBookmarks.changeSFInstance(n.oldSFInstance,n.newSFInstance),n.saveChanges(),alert("Instance has been changed for all bookmarks in this org"))},n.$watch("displaySettings",function(o,e){n.settingsMessage=""})}]),sfobApp.directive("bookmarkEditForm",["$interval","$timeout",function(o,e){return{restrict:"EA",scope:{orgBookmarks:"=",group:"=",bookmark:"=",onClose:"&"},template:'<div class="bookmark-edit-form-wrap"><input type="text" ng-model="bookmark.title"/><input type="text" ng-model="bookmark.url"/><div><select ng-model="selectedGroup" ng-options="group.name for group in groups" ng-change="moveToGroup(selectedGroup)"></select></div></div>',link:function(e,o,r){e.selectedGroup=e.group,e.groups=e.orgBookmarks.groups,e.moveToGroup=function(o){e.orgBookmarks.moveBookmarkToGroup(e.bookmark,e.group,o),e.group=o,e.onClose&&e.onClose()}}}}]),sfobApp.factory("Bookmark",["$q","utils","windowService",function(o,e,t){var n={title:"",url:"",createdDate:"",lastUseDate:""};return function(o,e,r){return(n=o||{title:e,url:r}).createdDate=n.createdDate?new Date(n.createdDate):new Date,n.lastUseDate=n.lastUseDate?new Date(n.lastUseDate):new Date,n.open=function(){o.lastUseDate=new Date,t.navigateTo(this.url)},n.openInNewTab=function(){o.lastUseDate=new Date,t.openInNewTab(this.url)},n.changeSFInstance=function(o,e){this.url=this.url.replace(o,e)},n}}]),sfobApp.factory("bookmarksService",["$q","utils","OrgBookmarks","storageService",function(c,o,g,l){var f="orglist",r="lastExport";function k(o){return"orgInfo_"+o}return{getBookmarks:function(e){this.addToOrgsList(e);var r=c.defer(),o=k(e);return l.load(o).then(function(o){angular.isObject(o)||(o=angular.fromJson(o));o=new g(o,e);r.resolve(o)}),r.promise},updateBookmarks:function(o){var e=angular.toJson(o),o=k(o.orgId);l.save(o,e)},addToOrgsList:function(e){this.getAllOrgsIds().then(function(o){-1==(o=o||[]).indexOf(e)&&(o.push(e),l.save(f,o))})},getAllOrgsIds:function(){var e=c.defer();return l.load(f).then(function(o){e.resolve(o)}),e.promise},getAllOrgsKeys:function(){var r=c.defer();return this.getAllOrgsIds().then(function(o){var e=[];angular.forEach(o,function(o){e.push(k(o))}),r.resolve(e)}),r.promise},getAllOrgsBookmarks:function(){var r=c.defer();return this.getAllOrgsKeys().then(function(o){l.loadMultiple(o).then(function(o){var e={};angular.forEach(o,function(o){angular.isObject(o)||(o=angular.fromJson(o)),o.orgId&&(e[o.orgId]=o)}),r.resolve(e)})}),r.promise},removeAllOrgs:function(){return this.getAllOrgsKeys().then(function(o){l.removeMultiple(o),l.save(f,[])})},importOrgsBookmarks:function(o,e){function r(t,n){var a=0,s=0,u={};angular.forEach(o,function(o){a++;var e=n[o.orgId];e?(e=n[o.orgId],(r=new g(e)).mergeBookmarks(o),o=r):(s++,t.push(o.orgId));var r=k(o.orgId);u[r]=o}),c.all([l.saveMultiple(u),l.save(f,t)]).then(function(){i.resolve({numOrgs:a,numNewOrgs:s})})}var i=c.defer(),t=this;return e?t.removeAllOrgs().then(function(){r([],{})}):t.getAllOrgsIds().then(function(e){t.getAllOrgsBookmarks().then(function(o){r(e,o)})}),i.promise},getLastExportDate:function(){var e=c.defer();return l.load(r).then(function(o){o?e.resolve(new Date(o)):e.resolve(null)}),e.promise},setLastExportDateAsNow:function(){var o=new Date;l.save(r,o.toString())}}}]),sfobApp.factory("OrgBookmarks",["$q","utils","Bookmark",function(o,a,t,e){var r="Default",n={addGroup:function(o){o={name:o||"New Group",createdDate:new Date,bookmarks:[]};return this.groups.push(o),o},deleteGroup:function(o){delete this.groups[o]},getDefaultGroup:function(){this.groups=this.groups||[];var o=this.groups;if(0==o.length)return this.addGroup(r),o[0];var e=o[0];return angular.forEach(o,function(o){o.name==r&&(e=o)}),e},shiftGroup:function(o,e){o=this.groups.indexOf(o);return a.switchItems(this.groups,o,o+e)},isInGroup:function(o,e){for(var r=0;r<o.bookmarks.length;r++)if(o.bookmarks[r].url==e)return!0;return!1},getIndex:function(o,e){return o.bookmarks.indexOf(e)},addBookmark:function(o,e,r){o=new t(null,o,e);r=r||this.getDefaultGroup(),this.isInGroup(r,e)||r.bookmarks.push(o)},deleteBookmark:function(o,e){e=this.getIndex(o,e);o.bookmarks.splice(e,1)},moveBookmark:function(o,e,r){e=this.getIndex(o,e);return a.switchItems(o.bookmarks,e,e+r)},moveBookmarkToGroup:function(o,e,r){r.bookmarks.push(o),this.deleteBookmark(e,o)},getAllBookmarks:function(){var e=[];return angular.forEach(this.groups,function(o){angular.forEach(o.bookmarks,function(o){e.push(o)})}),e},mergeBookmarks:function(o){var t=this,n=a.arrayToMap(this.groups,"name");angular.forEach(o.groups,function(o){var e=o.name,r=n[e];r?angular.forEach(o.bookmarks,function(o){t.addBookmark(o.title,o.url,r)}):(t.groups.push(o),n[e]=o)})},forEachGroup:function(e){angular.forEach(this.groups,function(o){e(o)})},forEachBookmark:function(e){this.forEachGroup(function(o){angular.forEach(o.bookmarks,function(o){e(o)})})},changeSFInstance:function(e,r){this.forEachBookmark(function(o){console.log("bookmark:",o.title),o.changeSFInstance(e,r)})}};return function(e,o){return e=e||{orgId:o},angular.merge(e,n),e.orgId=e.orgId||o,e.groups=a.removeEmptyItems(e.groups),angular.forEach(e.groups,function(o){o.createdDate||(o.createdDate=new Date);for(var e=0;e<o.bookmarks.length;e++)o.bookmarks[e]=new t(o.bookmarks[e])}),e.bookmarks&&(angular.forEach(e.bookmarks,function(o){e.addBookmark(o.title,o.url)}),delete e.bookmarks),e}}]),sfobApp.factory("storageService",["$q","utils",function(n,o){return{load:function(e){var r=n.defer();return chrome.storage.sync.get(e,function(o){r.resolve(o[e])}),r.promise},loadMultiple:function(o){var e=n.defer();return chrome.storage.sync.get(o,function(o){e.resolve(o)}),e.promise},save:function(o,e){var r=n.defer(),t={};return t[o]=e,chrome.storage.sync.set(t,function(){r.resolve()}),r.promise},saveMultiple:function(o){var e=n.defer();return chrome.storage.sync.set(o,function(){e.resolve()}),e.promise},removeMultiple:function(o){chrome.storage.sync.remove(o)}}}]),sfobApp.factory("utils",["$q",function(o){var n=[];return{log:function(o,e,r,t){console.log(o,e,r,t),logMsg=o+(e?" "+e:"")+(r?" "+r:"")+(t?" "+t:""),angular.forEach(n,function(o){o(logMsg)})},addLogHandler:function(o){n.push(o)},switchItems:function(o,e,r){if(0<=e&&e<o.length&&0<=r&&r<o.length){var t=o[e],n=o[r];return o[r]=null,o[e]=n,o[r]=t,!0}return!1},removeEmptyItems:function(o){var e=[];return angular.forEach(o,function(o){o&&e.push(o)}),e},daysBetween:function(o,e){return Math.round(Math.abs((o.getTime()-e.getTime())/864e5))},daysUntillNow:function(o){var e=new Date;return this.daysBetween(o,e)},arrayToMap:function(o,r){var t={};return angular.forEach(o,function(o){var e=o[r];t[e]=o}),t}}}]),sfobApp.factory("windowService",["$q","utils","storageService",function(o,e,r){var t="lastOrgId";return{getActiveTab:function(){var e=o.defer();return chrome.tabs.query({active:!0,currentWindow:!0},function(o){e.resolve(o[0])}),e.promise},getActiveTabId:function(){var e=o.defer();return this.getActiveTab().then(function(o){e.resolve(o.id)}),e.promise},navigateTo:function(e){this.getActiveTab().then(function(o){chrome.tabs.update(o.id,{url:e})})},openInNewTab:function(o){chrome.tabs.create({url:o})},getOrgId:function(){var e=o.defer();return this.getActiveTabId().then(function(o){chrome.tabs.sendMessage(o,"getOrgId",function(o){"undefined"==o&&(o=""),o?(r.save(t,o),e.resolve(o)):r.load(t).then(function(o){e.resolve(o)})})}),e.promise}}}]);