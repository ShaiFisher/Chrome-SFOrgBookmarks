var sfobApp=angular.module("sfobApp",[]);sfobApp.controller("popupCtrl",["$scope","bookmarksService","windowService","utils","OrgBookmarks",function(a,b,c,d,e){const f=.6,g=60,h=g/f;c.getOrgId().then(function(c){b.getBookmarks(c).then(function(b){a.orgBookmarks=b,angular.forEach(b.getAllBookmarks(),function(a){var b=Math.min(d.daysUntillNow(a.lastUseDate),g);a.opacity=1-b/h})})}),a.saveChanges=function(){b.updateBookmarks(a.orgBookmarks)},a.deleteAllBookmarks=function(){a.orgBookmarks.groups=[],a.saveChanges()},a.addBookmark=function(b){c.getActiveTab().then(function(c){var d=c.title.indexOf(" ~ "),e=d>0?c.title.substring(0,d):c.title;a.orgBookmarks.addBookmark(e,c.url,b),a.saveChanges()})},a.deleteBookmark=function(b,c){a.orgBookmarks.deleteBookmark(b,c),a.saveChanges()},a.moveBookmark=function(b,c,d){a.orgBookmarks.moveBookmark(b,c,d)&&a.saveChanges()},a.shiftGroup=function(b,c){a.orgBookmarks.shiftGroup(b,c)&&a.saveChanges()},a.openBookmark=function(b){b.open(),a.saveChanges()},a.addGroup=function(){a.orgBookmarks.addGroup().editMode=!0,a.saveChanges()},a.deleteGroup=function(b){a.orgBookmarks.deleteGroup(b),a.saveChanges()}}]),sfobApp.directive("bookmarkEditForm",["$interval","$timeout",function(a,b){return{restrict:"EA",scope:{orgBookmarks:"=",group:"=",bookmark:"=",onClose:"&"},template:'<div class="bookmark-edit-form-wrap"><input type="text" ng-model="bookmark.title"/><input type="text" ng-model="bookmark.url"/><div><select ng-model="selectedGroup" ng-options="group.name for group in groups" ng-change="moveToGroup(selectedGroup)"></select></div></div>',link:function(a,b,c){a.selectedGroup=a.group,a.groups=a.orgBookmarks.groups,a.moveToGroup=function(b){a.orgBookmarks.moveBookmarkToGroup(a.bookmark,a.group,b),a.group=b,a.onClose&&a.onClose()}}}}]),sfobApp.factory("OrgBookmarks",["$q","utils","Bookmark",function(a,b,c,d){const e="Default",f="New Group";var g={addGroup:function(a){var b={name:a||f,createdDate:new Date,bookmarks:[]};return this.groups.push(b),b},deleteGroup:function(a){delete this.groups[a]},getDefaultGroup:function(){this.groups=this.groups||[];var a=this.groups;if(0==a.length)return this.addGroup(e),a[0];var b=a[0];return angular.forEach(a,function(a){a.name==e&&(b=a)}),b},shiftGroup:function(a,c){var d=this.groups.indexOf(a);return b.switchItems(this.groups,d,d+c)},getIndex:function(a,b){return a.bookmarks.indexOf(b)},addBookmark:function(a,b,d){var e=new c(null,a,b);d=d||this.getDefaultGroup(),d.bookmarks.push(e)},deleteBookmark:function(a,b){var c=this.getIndex(a,b);a.bookmarks.splice(c,1)},moveBookmark:function(a,c,d){var e=this.getIndex(a,c);return b.switchItems(a.bookmarks,e,e+d)},moveBookmarkToGroup:function(a,b,c){c.bookmarks.push(a),this.deleteBookmark(b,a)},getAllBookmarks:function(){var a=[];return angular.forEach(this.groups,function(b){angular.forEach(b.bookmarks,function(b){a.push(b)})}),a}};return function(a,d){return a=a||{orgId:d},angular.merge(a,g),a.orgId=a.orgId||d,a.groups=b.removeEmptyItems(a.groups),angular.forEach(a.groups,function(a){a.createdDate||(a.createdDate=new Date);for(var b=0;b<a.bookmarks.length;b++)a.bookmarks[b]=new c(a.bookmarks[b])}),a.bookmarks&&(angular.forEach(a.bookmarks,function(b){a.addBookmark(b.title,b.url)}),delete a.bookmarks),a}}]),sfobApp.factory("storageService",["$q","utils",function(a,b){return{load:function(b,c){var d=a.defer();return chrome.storage.sync.get(b,function(a){d.resolve(a[b])}),d.promise},save:function(a,b){var c={};c[a]=b,chrome.storage.sync.set(c)}}}]),sfobApp.factory("utils",["$q",function(a){const b=864e5;var c=[];return{log:function(a,b,d,e){console.log(a,b,d,e),logMsg=a+(b?" "+b:"")+(d?" "+d:"")+(e?" "+e:""),angular.forEach(c,function(a){a(logMsg)})},addLogHandler:function(a){c.push(a)},switchItems:function(a,b,c){if(b>=0&&b<a.length&&c>=0&&c<a.length){var d=a[b],e=a[c];return a[c]=null,a[b]=e,a[c]=d,!0}return!1},removeEmptyItems:function(a){var b=[];return angular.forEach(a,function(a){a&&b.push(a)}),b},daysBetween:function(a,c){return Math.round(Math.abs((a.getTime()-c.getTime())/b))},daysUntillNow:function(a){var b=new Date;return this.daysBetween(a,b)}}}]),sfobApp.factory("windowService",["$q","utils","storageService",function(a,b,c){const d="lastOrgId";return{getActiveTab:function(){var b=a.defer();return chrome.tabs.query({active:!0,currentWindow:!0},function(a){b.resolve(a[0])}),b.promise},getActiveTabId:function(){var b=a.defer();return this.getActiveTab().then(function(a){b.resolve(a.id)}),b.promise},navigateTo:function(a){this.getActiveTab().then(function(b){chrome.tabs.update(b.id,{url:a})})},getOrgId:function(){var b=a.defer();return this.getActiveTabId().then(function(a){chrome.tabs.sendMessage(a,"getOrgId",function(a){a?(c.save(d,a),b.resolve(a)):c.load(d).then(function(a){b.resolve(a)})})}),b.promise}}}]),sfobApp.factory("Bookmark",["$q","utils","windowService",function(a,b,c){var d={title:"",url:"",createdDate:"",lastUseDate:""};return function(a,b,e){return d=a||{title:b,url:e},d.createdDate=d.createdDate?new Date(d.createdDate):new Date,d.lastUseDate=d.lastUseDate?new Date(d.lastUseDate):new Date,d.open=function(){a.lastUseDate=new Date,c.navigateTo(this.url)},d}}]),sfobApp.factory("bookmarksService",["$q","utils","OrgBookmarks","storageService",function(a,b,c,d){function g(a){return"orgInfo_"+a}const e="orglist";return{loadFromStorage:function(a,b){chrome.storage.sync.get(a,b)},saveToStorage:function(a,b,c){var d={};d[a]=b,chrome.storage.sync.set(d,c)},getBookmarks:function(b){this.addToOrgsList(b);var d=a.defer(),e=g(b);return chrome.storage.sync.get(e,function(a){var f=new c(a[e],b);d.resolve(f)}),d.promise},updateBookmarks:function(a){var b=angular.toJson(a),c=angular.fromJson(b),d=g(a.orgId),e={};e[d]=c,chrome.storage.sync.set(e,function(){})},addToOrgsList:function(a){d.load(e).then(function(b){b=b||[],-1==b.indexOf(a)&&(b.push(a),d.save(e,b))})}}}]);